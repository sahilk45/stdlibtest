<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Numerical Methods Visualizer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.29.1/plotly.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #8e44ad;
      --primary-light: #9b59b6;
      --secondary: #3498db;
      --dark-bg: #121212;
      --dark-surface: #1e1e1e;
      --dark-card: #252525;
      --text-primary: #f5f5f5;
      --text-secondary: #aaaaaa;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--dark-bg);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    .navbar {
      background-color: var(--dark-surface);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .navbar-title {
      font-weight: 700;
      font-size: 1.5rem;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .navbar-links {
      display: flex;
      gap: 1.5rem;
    }
    
    .navbar-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    
    .navbar-links a:hover {
      color: var(--primary-light);
    }
    
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .card {
      background-color: var(--dark-card);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #444;
      color: var(--primary-light);
    }
    
    .flex-container {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    
    .input-section {
      flex: 1;
      min-width: 300px;
    }
    
    .output-section {
      flex: 2;
      min-width: 400px;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    input[type="text"], 
    input[type="number"],
    select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 4px;
      border: 1px solid #444;
      background-color: #333;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      transition: border-color 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    button {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease, opacity 0.2s ease;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }
    
    .results-table th, .results-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    
    .results-table th {
      color: var(--secondary);
      font-weight: 600;
    }
    
    .results-table tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .plot-container {
      width: 100%;
      height: 500px;
      margin-top: 1rem;
      margin-bottom: 2rem;
    }
    
    .status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .status.success {
      background-color: rgba(46, 204, 113, 0.2);
      border-left: 4px solid var(--success);
    }
    
    .status.error {
      background-color: rgba(231, 76, 60, 0.2);
      border-left: 4px solid var(--danger);
    }
    
    .function-editor {
      font-family: 'JetBrains Mono', monospace;
      background-color: #333;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 0.75rem;
      width: 100%;
      min-height: 100px;
      margin-bottom: 1rem;
    }
    
    .tab-container {
      margin-bottom: 1rem;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #444;
      margin-bottom: 1rem;
    }
    
    .tab-button {
      background: none;
      border: none;
      padding: 0.75rem 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-right: 0;
      margin-bottom: 0;
    }
    
    .tab-button.active {
      color: var(--primary-light);
      border-bottom-color: var(--primary-light);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    
    .badge.success {
      background-color: var(--success);
      color: white;
    }
    
    .badge.warning {
      background-color: var(--warning);
      color: white;
    }
    
    .badge.error {
      background-color: var(--danger);
      color: white;
    }
    
    footer {
      background-color: var(--dark-surface);
      padding: 1.5rem 2rem;
      text-align: center;
      color: var(--text-secondary);
      margin-top: 3rem;
    }
    
    @media (max-width: 768px) {
      .flex-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-title">
      <i class="fas fa-square-root-alt"></i>
      Numerical Methods Visualizer
    </div>
    <div class="navbar-links">
      <a href="#" class="active">Home</a>
      <a href="#about">About</a>
      <a href="#" id="theme-toggle"><i class="fas fa-moon"></i></a>
    </div>
  </nav>
  
  <div class="container">
    <div class="card">
      <h2 class="card-title">Interactive Numerical Methods</h2>
      
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="differentiation">Differentiation</button>
          <button class="tab-button" data-tab="integration">Integration</button>
          <button class="tab-button" data-tab="comparison">Convergence Analysis</button>
        </div>
        
        <div class="tab-content active" id="differentiation-tab">
          <div class="flex-container">
            <div class="input-section">
              <div class="form-group">
                <label for="diff-function">Function f(x)</label>
                <input type="text" id="diff-function" placeholder="e.g., x^3 - 2*x^2 + 3*x - 5" value="x^3 - 2*x^2 + 3*x - 5">
              </div>
              <div class="form-group">
                <label for="diff-range-start">Range Start</label>
                <input type="number" id="diff-range-start" value="-2" step="0.1">
              </div>
              <div class="form-group">
                <label for="diff-range-end">Range End</label>
                <input type="number" id="diff-range-end" value="2" step="0.1">
              </div>
              <div class="form-group">
                <label for="diff-points">Number of Points</label>
                <input type="number" id="diff-points" value="100" min="10" max="1000">
              </div>
              <div class="form-group">
                <label for="diff-h">Step Size (h)</label>
                <input type="number" id="diff-h" value="0.001" step="0.001" min="0.0001" max="0.1">
              </div>
              <button id="calculate-diff" onclick="calculateDifferentiation()">Calculate</button>
              <button id="reset-diff" onclick="resetDifferentiation()">Reset</button>
            </div>
            
            <div class="output-section">
              <div id="diff-plot" class="plot-container"></div>
              <div id="diff-results"></div>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="integration-tab">
          <div class="flex-container">
            <div class="input-section">
              <div class="form-group">
                <label for="int-function">Function f(x)</label>
                <input type="text" id="int-function" placeholder="e.g., x^3 - 2*x^2 + 3*x - 5" value="x^3 - 2*x^2 + 3*x - 5">
              </div>
              <div class="form-group">
                <label for="int-lower">Lower Bound</label>
                <input type="number" id="int-lower" value="0" step="0.1">
              </div>
              <div class="form-group">
                <label for="int-upper">Upper Bound</label>
                <input type="number" id="int-upper" value="1" step="0.1">
              </div>
              <div class="form-group">
                <label for="int-intervals">Number of Intervals</label>
                <input type="number" id="int-intervals" value="100" min="10" max="1000">
              </div>
              <button id="calculate-int" onclick="calculateIntegration()">Calculate</button>
              <button id="reset-int" onclick="resetIntegration()">Reset</button>
            </div>
            
            <div class="output-section">
              <div id="int-plot" class="plot-container"></div>
              <div id="int-results"></div>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="comparison-tab">
          <div class="flex-container">
            <div class="input-section">
              <div class="form-group">
                <label for="conv-function">Function f(x)</label>
                <input type="text" id="conv-function" placeholder="e.g., x^3 - 2*x^2 + 3*x - 5" value="x^3 - 2*x^2 + 3*x - 5">
              </div>
              <div class="form-group">
                <label for="conv-lower">Lower Bound</label>
                <input type="number" id="conv-lower" value="0" step="0.1">
              </div>
              <div class="form-group">
                <label for="conv-upper">Upper Bound</label>
                <input type="number" id="conv-upper" value="1" step="0.1">
              </div>
              <div class="form-group">
                <label>Interval Sizes</label>
                <div style="display: flex; gap: 0.5rem;">
                  <input type="number" id="n-value-1" value="10" min="4" max="500">
                  <input type="number" id="n-value-2" value="20" min="4" max="500">
                  <input type="number" id="n-value-3" value="40" min="4" max="500">
                  <input type="number" id="n-value-4" value="80" min="4" max="500">
                  <input type="number" id="n-value-5" value="160" min="4" max="500">
                </div>
              </div>
              <button id="calculate-conv" onclick="calculateConvergence()">Calculate</button>
              <button id="reset-conv" onclick="resetConvergence()">Reset</button>
            </div>
            
            <div class="output-section">
              <div id="conv-plot" class="plot-container"></div>
              <div id="conv-results"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card" id="about">
      <h2 class="card-title">About This Tool</h2>
      <p>This interactive visualizer demonstrates various numerical methods for differentiation and integration:</p>
      <ul style="margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 1rem;">
        <li><strong>Numerical Differentiation:</strong> Forward and backward difference methods for approximating derivatives.</li>
        <li><strong>Numerical Integration:</strong> Trapezoidal rule and Simpson's rule for approximating definite integrals.</li>
        <li><strong>Convergence Analysis:</strong> Examine how error decreases as the number of intervals increases.</li>
      </ul>
      <p>Enter your function, adjust parameters, and visualize the results with interactive plots.</p>
    </div>
  </div>
  
  <footer>
    <p>Numerical Methods Visualizer © 2025 | Created with Plotly.js</p>
  </footer>

  <script>
    // Mathematical expression parser and evaluator
    function createFunction(expression) {
      // Replace ^ with ** for JavaScript exponentiation
      expression = expression.replace(/\^/g, '**');
      
      try {
        // Create a function that evaluates the expression
        return new Function('x', `return ${expression};`);
      } catch (error) {
        console.error("Error creating function:", error);
        return null;
      }
    }
    
    // Numerical Methods Implementation
    function forwardDifference(fn, x, h = 0.001) {
      return (fn(x + h) - fn(x)) / h;
    }
    
    function backwardDifference(fn, x, h = 0.001) {
      return (fn(x) - fn(x - h)) / h;
    }
    
    function centralDifference(fn, x, h = 0.001) {
      return (fn(x + h) - fn(x - h)) / (2 * h);
    }
    
    function trapezoidalRule(fn, a, b, n = 100) {
      const h = (b - a) / n;
      let sum = fn(a) / 2 + fn(b) / 2;
      
      for (let i = 1; i < n; i++) {
        const x = a + i * h;
        sum += fn(x);
      }
      return h * sum;
    }
    
    function simpsonsRule(fn, a, b, n = 100) {
      if (n % 2 !== 0) n += 1;
      
      const h = (b - a) / n;
      let sum = fn(a) + fn(b);
      
      for (let i = 1; i < n; i++) {
        const x = a + i * h;
        const coefficient = (i % 2 === 0) ? 2 : 4;
        sum += coefficient * fn(x);
      }
      return (h / 3) * sum;
    }
    
    // Analytical derivatives for common functions
    function getAnalyticalDerivative(expression) {
      // This is a simplified derivative calculator for basic functions
      // In a real app, you'd use a symbolic math library
      
      // Handle polynomial expressions - very simplified approach
      if (expression.includes('x^3')) {
        return '3*x^2';
      } else if (expression.includes('x^2')) {
        return '2*x';
      } else if (expression.includes('x^')) {
        const match = expression.match(/x\^(\d+)/);
        if (match) {
          const power = parseInt(match[1]);
          return `${power}*x^${power-1}`;
        }
      }
      
      if (expression === 'sin(x)') return 'cos(x)';
      if (expression === 'cos(x)') return '-sin(x)';
      if (expression === 'x^3 - 2*x^2 + 3*x - 5') return '3*x^2 - 4*x + 3';
      
      // Default: we'll use central difference if analytical derivative can't be determined
      return null;
    }
    
    // Analytical integrals for common functions
    function getAnalyticalIntegral(expression, a, b) {
      // This is a simplified integral calculator for basic functions
      
      if (expression === 'x^3 - 2*x^2 + 3*x - 5') {
        const F = (x) => (Math.pow(x, 4)/4) - (2*Math.pow(x, 3)/3) + (3*Math.pow(x, 2)/2) - 5*x;
        return F(b) - F(a);
      }
      
      if (expression === 'sin(x)') {
        return -Math.cos(b) + Math.cos(a);
      }
      
      // Default: we'll use Simpson's rule with many intervals for reference
      return null;
    }
    
    // UI Tab Handling
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons and tabs
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Add active class to clicked button and corresponding tab
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab') + '-tab';
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // Differentiation Calculator
    function calculateDifferentiation() {
      const functionExpression = document.getElementById('diff-function').value;
      const rangeStart = parseFloat(document.getElementById('diff-range-start').value);
      const rangeEnd = parseFloat(document.getElementById('diff-range-end').value);
      const numPoints = parseInt(document.getElementById('diff-points').value);
      const h = parseFloat(document.getElementById('diff-h').value);
      
      try {
        const fn = createFunction(functionExpression);
        if (!fn) throw new Error("Invalid function expression");
        
        // Generate x values
        const xValues = [];
        const step = (rangeEnd - rangeStart) / (numPoints - 1);
        for (let i = 0; i < numPoints; i++) {
          xValues.push(rangeStart + i * step);
        }
        
        // Calculate function values
        const fValues = xValues.map(x => fn(x));
        
        // Calculate derivatives
        const forwardValues = xValues.map(x => forwardDifference(fn, x, h));
        const backwardValues = xValues.map(x => backwardDifference(fn, x, h));
        const centralValues = xValues.map(x => centralDifference(fn, x, h));
        
        // If analytical derivative is available, use it for comparison
        const analyticalExpression = getAnalyticalDerivative(functionExpression);
        let analyticalValues = [];
        let errorForward = [];
        let errorBackward = [];
        let errorCentral = [];
        
        if (analyticalExpression) {
          const analyticalFn = createFunction(analyticalExpression);
          analyticalValues = xValues.map(x => analyticalFn(x));
          
          // Calculate errors
          errorForward = forwardValues.map((val, i) => Math.abs(val - analyticalValues[i]));
          errorBackward = backwardValues.map((val, i) => Math.abs(val - analyticalValues[i]));
          errorCentral = centralValues.map((val, i) => Math.abs(val - analyticalValues[i]));
        }
        
        // Create plot
        const traces = [
          {
            x: xValues,
            y: fValues,
            mode: 'lines',
            name: 'f(x)',
            line: { color: '#3498db', width: 2 }
          },
          {
            x: xValues,
            y: forwardValues,
            mode: 'lines',
            name: 'Forward Diff',
            line: { color: '#2ecc71', width: 2, dash: 'dash' }
          },
          {
            x: xValues,
            y: backwardValues,
            mode: 'lines',
            name: 'Backward Diff',
            line: { color: '#e74c3c', width: 2, dash: 'dot' }
          },
          {
            x: xValues,
            y: centralValues,
            mode: 'lines',
            name: 'Central Diff',
            line: { color: '#f39c12', width: 2, dash: 'dashdot' }
          }
        ];
        
        // Add analytical derivative if available
        if (analyticalValues.length > 0) {
          traces.push({
            x: xValues,
            y: analyticalValues,
            mode: 'lines',
            name: 'Analytical',
            line: { color: '#9b59b6', width: 3 }
          });
        }
        
        const layout = {
          title: 'Numerical Differentiation',
          plot_bgcolor: 'rgba(0,0,0,0)',
          paper_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#f5f5f5' },
          xaxis: {
            title: 'x',
            gridcolor: '#444'
          },
          yaxis: {
            title: 'Value',
            gridcolor: '#444'
          },
          legend: { 
            x: 0, 
            y: 1,
            bgcolor: 'rgba(30,30,30,0.8)',
            bordercolor: '#444'
          },
          margin: { t: 60, b: 60, l: 60, r: 40 }
        };
        
        Plotly.newPlot('diff-plot', traces, layout, { responsive: true });
        
        // Display error statistics if analytical derivative is available
        let resultsHTML = '';
        
        if (analyticalValues.length > 0) {
          const avgErrorForward = errorForward.reduce((sum, val) => sum + val, 0) / errorForward.length;
          const avgErrorBackward = errorBackward.reduce((sum, val) => sum + val, 0) / errorBackward.length;
          const avgErrorCentral = errorCentral.reduce((sum, val) => sum + val, 0) / errorCentral.length;
          const maxErrorForward = Math.max(...errorForward);
          const maxErrorBackward = Math.max(...errorBackward);
          const maxErrorCentral = Math.max(...errorCentral);
          
          resultsHTML = `
            <div class="status success">
              <p>Successfully calculated derivatives! Analytical formula used: f'(x) = ${analyticalExpression}</p>
            </div>
            <table class="results-table">
              <thead>
                <tr>
                  <th>Method</th>
                  <th>Average Error</th>
                  <th>Maximum Error</th>
                  <th>Performance</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Forward Difference</td>
                  <td>${avgErrorForward.toExponential(4)}</td>
                  <td>${maxErrorForward.toExponential(4)}</td>
                  <td>
                    ${getPerformanceBadge(avgErrorForward, avgErrorBackward, avgErrorCentral)}
                  </td>
                </tr>
                <tr>
                  <td>Backward Difference</td>
                  <td>${avgErrorBackward.toExponential(4)}</td>
                  <td>${maxErrorBackward.toExponential(4)}</td>
                  <td>
                    ${getPerformanceBadge(avgErrorBackward, avgErrorForward, avgErrorCentral)}
                  </td>
                </tr>
                <tr>
                  <td>Central Difference</td>
                  <td>${avgErrorCentral.toExponential(4)}</td>
                  <td>${maxErrorCentral.toExponential(4)}</td>
                  <td>
                    ${getPerformanceBadge(avgErrorCentral, avgErrorForward, avgErrorBackward)}
                  </td>
                </tr>
              </tbody>
            </table>
          `;
        } else {
          resultsHTML = `
            <div class="status success">
              <p>Successfully calculated numerical derivatives for f(x) = ${functionExpression}</p>
              <p>No analytical derivative available for comparison. Results are shown in the plot.</p>
            </div>
          `;
        }
        
        document.getElementById('diff-results').innerHTML = resultsHTML;
        
      } catch (error) {
        document.getElementById('diff-results').innerHTML = `
          <div class="status error">
            <p>Error: ${error.message}</p>
          </div>
        `;
      }
    }
    
    function getPerformanceBadge(current, other1, other2) {
      if (current <= other1 && current <= other2) {
        return '<span class="badge success">Best</span>';
      } else if (current <= other1 || current <= other2) {
        return '<span class="badge warning">Good</span>';
      } else {
        return '<span class="badge error">Worst</span>';
      }
    }
    
    function resetDifferentiation() {
      document.getElementById('diff-function').value = 'x^3 - 2*x^2 + 3*x - 5';
      document.getElementById('diff-range-start').value = '-2';
      document.getElementById('diff-range-end').value = '2';
      document.getElementById('diff-points').value = '100';
      document.getElementById('diff-h').value = '0.001';
      document.getElementById('diff-results').innerHTML = '';
      Plotly.purge('diff-plot');
    }
    
    // Integration Calculator
    function calculateIntegration() {
      const functionExpression = document.getElementById('int-function').value;
      const lowerBound = parseFloat(document.getElementById('int-lower').value);
      const upperBound = parseFloat(document.getElementById('int-upper').value);
      const numIntervals = parseInt(document.getElementById('int-intervals').value);
      
      try {
        const fn = createFunction(functionExpression);
        if (!fn) throw new Error("Invalid function expression");
        
        // Generate x values for plotting the function
        const numPoints = 200;
        const xValues = [];
        const step = (upperBound - lowerBound) / (numPoints - 1);
        for (let i = 0; i < numPoints; i++) {
          xValues.push(lowerBound + i * step);
        }
        
        // Calculate function values
        const fValues = xValues.map(x => fn(x));
        
        // Calculate integration using different methods
        const trapResult = trapezoidalRule(fn, lowerBound, upperBound, numIntervals);

        const simpResult = simpsonsRule(fn, lowerBound, upperBound, numIntervals);
        
        // Check if analytical integral is available
        const analyticalResult = getAnalyticalIntegral(functionExpression, lowerBound, upperBound);
        
        // Create data for filled area under curve visualization
        const fillX = [...xValues, upperBound, lowerBound];
        const fillY = [...fValues, 0, 0];
        
        // Create rectangles for trapezoidal visualization
        const trapXValues = [];
        const trapYValues = [];
        const trapWidth = (upperBound - lowerBound) / numIntervals;
        
        // Only show visualization rectangles if intervals aren't too many (UI gets cluttered)
        const showRectangles = numIntervals <= 20;
        
        if (showRectangles) {
          for (let i = 0; i <= numIntervals; i++) {
            const x = lowerBound + i * trapWidth;
            const y = fn(x);
            
            // Add points to create rectangle shapes
            if (i < numIntervals) {
              trapXValues.push(x, x + trapWidth, x + trapWidth, x, x);
              trapYValues.push(0, 0, y, y, 0);
            }
          }
        }
        
        // Create plot
        const traces = [
          {
            x: xValues,
            y: fValues,
            type: 'scatter',
            mode: 'lines',
            name: 'f(x)',
            line: { color: '#3498db', width: 2 }
          },
          {
            x: fillX,
            y: fillY,
            fill: 'toself',
            fillcolor: 'rgba(52, 152, 219, 0.2)',
            line: { width: 0 },
            name: 'Area',
            showlegend: false
          }
        ];
        
        // Add visualization for trapezoidal method if we're not showing too many intervals
        if (showRectangles) {
          traces.push({
            x: trapXValues,
            y: trapYValues,
            type: 'scatter',
            mode: 'lines',
            name: 'Trapezoids',
            line: { color: '#e74c3c', width: 1 }
          });
        }
        
        const layout = {
          title: 'Numerical Integration',
          plot_bgcolor: 'rgba(0,0,0,0)',
          paper_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#f5f5f5' },
          xaxis: {
            title: 'x',
            gridcolor: '#444'
          },
          yaxis: {
            title: 'f(x)',
            gridcolor: '#444'
          },
          legend: { 
            x: 0, 
            y: 1,
            bgcolor: 'rgba(30,30,30,0.8)',
            bordercolor: '#444'
          },
          margin: { t: 60, b: 60, l: 60, r: 40 }
        };
        
        Plotly.newPlot('int-plot', traces, layout, { responsive: true });
        
        // Display results
        let resultsHTML = '';
        let errorTrap = 0;
        let errorSimp = 0;
        
        if (analyticalResult !== null) {
          errorTrap = Math.abs((trapResult - analyticalResult) / analyticalResult) * 100;
          errorSimp = Math.abs((simpResult - analyticalResult) / analyticalResult) * 100;
          
          resultsHTML = `
            <div class="status success">
              <p>Successfully calculated integrals! Analytical result: ${analyticalResult.toFixed(8)}</p>
            </div>
            <table class="results-table">
              <thead>
                <tr>
                  <th>Method</th>
                  <th>Result</th>
                  <th>Absolute Error</th>
                  <th>Relative Error (%)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Trapezoidal Rule (n=${numIntervals})</td>
                  <td>${trapResult.toFixed(8)}</td>
                  <td>${Math.abs(trapResult - analyticalResult).toExponential(4)}</td>
                  <td>${errorTrap.toFixed(6)}%</td>
                </tr>
                <tr>
                  <td>Simpson's Rule (n=${numIntervals})</td>
                  <td>${simpResult.toFixed(8)}</td>
                  <td>${Math.abs(simpResult - analyticalResult).toExponential(4)}</td>
                  <td>${errorSimp.toFixed(6)}%</td>
                </tr>
              </tbody>
            </table>
          `;
        } else {
          // Use Simpson's rule with many intervals as reference when analytical result is not available
          const referenceResult = simpsonsRule(fn, lowerBound, upperBound, 1000);
          errorTrap = Math.abs((trapResult - referenceResult) / referenceResult) * 100;
          errorSimp = Math.abs((simpResult - referenceResult) / referenceResult) * 100;
          
          resultsHTML = `
            <div class="status success">
              <p>Successfully calculated integrals for f(x) = ${functionExpression}</p>
              <p>No analytical result available. Using high-precision numerical estimate as reference.</p>
            </div>
            <table class="results-table">
              <thead>
                <tr>
                  <th>Method</th>
                  <th>Result</th>
                  <th>Estimated Error (%)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Trapezoidal Rule (n=${numIntervals})</td>
                  <td>${trapResult.toFixed(8)}</td>
                  <td>${errorTrap.toFixed(6)}%</td>
                </tr>
                <tr>
                  <td>Simpson's Rule (n=${numIntervals})</td>
                  <td>${simpResult.toFixed(8)}</td>
                  <td>${errorSimp.toFixed(6)}%</td>
                </tr>
                <tr>
                  <td>Reference (Simpson n=1000)</td>
                  <td>${referenceResult.toFixed(8)}</td>
                  <td>-</td>
                </tr>
              </tbody>
            </table>
          `;
        }
        
        document.getElementById('int-results').innerHTML = resultsHTML;
        
      } catch (error) {
        document.getElementById('int-results').innerHTML = `
          <div class="status error">
            <p>Error: ${error.message}</p>
          </div>
        `;
      }
    }
    
    function resetIntegration() {
      document.getElementById('int-function').value = 'x^3 - 2*x^2 + 3*x - 5';
      document.getElementById('int-lower').value = '0';
      document.getElementById('int-upper').value = '1';
      document.getElementById('int-intervals').value = '100';
      document.getElementById('int-results').innerHTML = '';
      Plotly.purge('int-plot');
    }
    
    // Convergence Analysis Calculator
    function calculateConvergence() {
      const functionExpression = document.getElementById('conv-function').value;
      const lowerBound = parseFloat(document.getElementById('conv-lower').value);
      const upperBound = parseFloat(document.getElementById('conv-upper').value);
      
      // Get the different interval sizes
      const nValues = [];
      for (let i = 1; i <= 5; i++) {
        nValues.push(parseInt(document.getElementById(`n-value-${i}`).value));
      }
      
      try {
        const fn = createFunction(functionExpression);
        if (!fn) throw new Error("Invalid function expression");
        
        // Get analytical result if available
        const analyticalResult = getAnalyticalIntegral(functionExpression, lowerBound, upperBound);
        
        // If not available, use a high-precision numerical estimate
        const referenceResult = analyticalResult !== null ? 
              analyticalResult : 
              simpsonsRule(fn, lowerBound, upperBound, 10000);
        
        // Calculate using different methods and interval sizes
        const trapResults = [];
        const simpResults = [];
        const trapErrors = [];
        const simpErrors = [];
        
        nValues.forEach(n => {
          const trapResult = trapezoidalRule(fn, lowerBound, upperBound, n);
          const simpResult = simpsonsRule(fn, lowerBound, upperBound, n);
          
          trapResults.push(trapResult);
          simpResults.push(simpResult);
          
          // Calculate errors
          const trapError = Math.abs(trapResult - referenceResult);
          const simpError = Math.abs(simpResult - referenceResult);
          
          trapErrors.push(trapError);
          simpErrors.push(simpError);
        });
        
        // Create convergence plot
        const traces = [
          {
            x: nValues,
            y: trapErrors,
            mode: 'lines+markers',
            name: 'Trapezoidal Rule Error',
            line: { color: '#e74c3c', width: 2 },
            marker: { size: 8, symbol: 'circle' }
          },
          {
            x: nValues,
            y: simpErrors,
            mode: 'lines+markers',
            name: 'Simpson\'s Rule Error',
            line: { color: '#2ecc71', width: 2 },
            marker: { size: 8, symbol: 'square' }
          }
        ];
        
        const layout = {
          title: 'Convergence Analysis',
          plot_bgcolor: 'rgba(0,0,0,0)',
          paper_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#f5f5f5' },
          xaxis: {
            title: 'Number of Intervals (n)',
            type: 'log',
            gridcolor: '#444'
          },
          yaxis: {
            title: 'Absolute Error',
            type: 'log',
            gridcolor: '#444'
          },
          legend: { 
            x: 0, 
            y: 1,
            bgcolor: 'rgba(30,30,30,0.8)',
            bordercolor: '#444'
          },
          margin: { t: 60, b: 60, l: 60, r: 40 }
        };
        
        Plotly.newPlot('conv-plot', traces, layout, { responsive: true });
        
        // Calculate convergence rates
        const trapRates = [];
        const simpRates = [];
        
        for (let i = 0; i < nValues.length - 1; i++) {
          const n1 = nValues[i];
          const n2 = nValues[i + 1];
          const e1_trap = trapErrors[i];
          const e2_trap = trapErrors[i + 1];
          const e1_simp = simpErrors[i];
          const e2_simp = simpErrors[i + 1];
          
          // Calculate rates based on theoretical error ~ h^p
          // log(e2/e1) / log(h1/h2) = log(e2/e1) / log(n2/n1)
          const trapRate = Math.log(e2_trap / e1_trap) / Math.log(n1 / n2);
          const simpRate = Math.log(e2_simp / e1_simp) / Math.log(n1 / n2);
          
          trapRates.push(trapRate);
          simpRates.push(simpRate);
        }
        
        // Display results
        let resultsHTML = '';
        
        resultsHTML = `
          <div class="status success">
            <p>Successfully analyzed convergence for integrals of f(x) = ${functionExpression}</p>
            <p>Reference value: ${referenceResult.toFixed(8)} ${analyticalResult !== null ? '(analytical)' : '(high-precision numerical)'}</p>
          </div>
          <table class="results-table">
            <thead>
              <tr>
                <th>Intervals (n)</th>
                <th>Trapezoidal Result</th>
                <th>Trapezoidal Error</th>
                <th>Simpson's Result</th>
                <th>Simpson's Error</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        nValues.forEach((n, i) => {
          resultsHTML += `
            <tr>
              <td>${n}</td>
              <td>${trapResults[i].toFixed(8)}</td>
              <td>${trapErrors[i].toExponential(4)}</td>
              <td>${simpResults[i].toFixed(8)}</td>
              <td>${simpErrors[i].toExponential(4)}</td>
            </tr>
          `;
        });
        
        resultsHTML += `
            </tbody>
          </table>
          
          <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--primary-light);">Convergence Rates</h3>
          <table class="results-table">
            <thead>
              <tr>
                <th>Interval Range</th>
                <th>Trapezoidal Rate</th>
                <th>Simpson's Rate</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        for (let i = 0; i < trapRates.length; i++) {
          resultsHTML += `
            <tr>
              <td>${nValues[i]} → ${nValues[i+1]}</td>
              <td>${trapRates[i].toFixed(4)}</td>
              <td>${simpRates[i].toFixed(4)}</td>
              <td>${getConvergenceNote(trapRates[i], simpRates[i])}</td>
            </tr>
          `;
        }
        
        resultsHTML += `
            </tbody>
          </table>
          <p style="margin-top: 1rem; color: var(--text-secondary);">
            <i>Theoretical rates: Trapezoidal O(h²) ≈ 2.0, Simpson's O(h⁴) ≈ 4.0</i>
          </p>
        `;
        
        document.getElementById('conv-results').innerHTML = resultsHTML;
        
      } catch (error) {
        document.getElementById('conv-results').innerHTML = `
          <div class="status error">
            <p>Error: ${error.message}</p>
          </div>
        `;
      }
    }
    
    function getConvergenceNote(trapRate, simpRate) {
      let note = '';
      
      if (Math.abs(trapRate - 2.0) < 0.5) {
        note += '<span class="badge success">Trap: Expected</span> ';
      } else {
        note += '<span class="badge warning">Trap: Unusual</span> ';
      }
      
      if (Math.abs(simpRate - 4.0) < 1.0) {
        note += '<span class="badge success">Simp: Expected</span>';
      } else {
        note += '<span class="badge warning">Simp: Unusual</span>';
      }
      
      return note;
    }
    
    function resetConvergence() {
      document.getElementById('conv-function').value = 'x^3 - 2*x^2 + 3*x - 5';
      document.getElementById('conv-lower').value = '0';
      document.getElementById('conv-upper').value = '1';
      document.getElementById('n-value-1').value = '10';
      document.getElementById('n-value-2').value = '20';
      document.getElementById('n-value-3').value = '40';
      document.getElementById('n-value-4').value = '80';
      document.getElementById('n-value-5').value = '160';
      document.getElementById('conv-results').innerHTML = '';
      Plotly.purge('conv-plot');
    }
    
    // Theme toggle functionality
    document.getElementById('theme-toggle').addEventListener('click', function() {
      const icon = this.querySelector('i');
      const isLightMode = icon.classList.contains('fa-sun');
      
      // Toggle icon
      if (isLightMode) {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
        // Would add dark mode switch code here
      } else {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
        // Would add light mode switch code here
      }
      
      // In a full implementation, would toggle color scheme CSS variables here
    });
    
    // Initialize with differentiation calculator when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      calculateDifferentiation();
    });
  </script>
</body>
</html>